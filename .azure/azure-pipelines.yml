# Azure pipeline to build & deploy GoAdmin demo site
# https://docs.microsoft.com/azure/devops/pipelines/

trigger:
  batch: true
  branches:
    include:
    - '*'

pool:
  vmImage: ubuntu-latest

variables:
  goVersion: '1.17'
  GOBIN: '$(GOROOT)/bin'
  GO111MODULE: 'on'
  goBuiltAppName: 'goadmin'
  sessionDirectory: $(System.DefaultWorkingDirectory)/..
  projectName: 'goadmincp-seed'
  projectDirectory: $(sessionDirectory)/$(projectName)
  # GOBIN:  '$(GOPATH)/bin' # Go binaries path
  # GOROOT: '/usr/local/go1.11' # Go installation path
  # GOPATH: '$(system.defaultWorkingDirectory)/gopath' # Go workspace path
  # modulePath: '$(GOPATH)/src/github.com/$(build.repository.name)' # Path to the module's code

stages:
- stage: build_and_test
  displayName: Build and Test
  jobs:
  - job: build
    displayName: Build project
    steps:
    - task: GoTool@0
      displayName: Prepare Go env
      inputs:
        version: '$(goVersion)'
    - task: Go@0
      inputs:
        # minimum go-giter8 v0.5.1 for "quiet" mode
        command: 'get'
        arguments: 'github.com/btnguyen2k/go-giter8/g8@v0.5.1'
      displayName: Install go-giter8
    - script: |
        g8 --version
        g8 new --no-inputs file://$(System.DefaultWorkingDirectory)
      displayName: Generate project using go-giter8
      workingDirectory: $(sessionDirectory)
    - script: cd $(projectDirectory) && go build -o $(goBuiltAppName) -tags netgo -a
      displayName: 'go build'
  - job: test
    displayName: Test project
    steps:
    - task: GoTool@0
      displayName: Prepare Go env
      inputs:
        version: '$(goVersion)'
    - task: Go@0
      inputs:
        # minimum go-giter8 v0.5.1 for "quiet" mode
        command: 'get'
        arguments: 'github.com/btnguyen2k/go-giter8/g8@v0.5.1'
      displayName: Install go-giter8
    - script: |
        g8 --version
        g8 new --no-inputs file://$(System.DefaultWorkingDirectory)
      displayName: Generate project using go-giter8
      workingDirectory: $(sessionDirectory)
    - script: cd $(projectDirectory) && go build -o $(goBuiltAppName) -tags netgo -a
      displayName: 'go build'
